name: CI Pipeline - Mythos Archives

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Auth Service
  auth-service:
    name: Auth Service - Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "auth-service/package-lock.json"

      - name: Install dependencies
        working-directory: ./auth-service
        run: npm ci

      - name: Generate Prisma Client
        working-directory: ./auth-service
        run: npx prisma generate

      - name: Run ESLint
        working-directory: ./auth-service
        run: npm run lint

      - name: Build TypeScript
        working-directory: ./auth-service
        run: npm run build

      - name: Check build output
        working-directory: ./auth-service
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist folder not created"
            exit 1
          fi
          echo "‚úÖ Build successful"

  # Job 2: Lore Service
  lore-service:
    name: Lore Service - Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "lore-service/package-lock.json"

      - name: Install dependencies
        working-directory: ./lore-service
        run: npm ci

      - name: Run ESLint
        working-directory: ./lore-service
        run: npm run lint

      - name: Build TypeScript
        working-directory: ./lore-service
        run: npm run build

      - name: Check build output
        working-directory: ./lore-service
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist folder not created"
            exit 1
          fi
          echo "‚úÖ Build successful"

  # Job 3: Mythology Service
  mythology-service:
    name: Mythology Service - Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "mythology-service/package-lock.json"

      - name: Install dependencies
        working-directory: ./mythology-service
        run: npm ci

      - name: Run ESLint
        working-directory: ./mythology-service
        run: npm run lint

      - name: Build TypeScript
        working-directory: ./mythology-service
        run: npm run build

      - name: Check build output
        working-directory: ./mythology-service
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist folder not created"
            exit 1
          fi
          echo "‚úÖ Build successful"

  # Job 4: Summary (s'ex√©cute apr√®s tous les autres)
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [auth-service, lore-service, mythology-service]

    steps:
      - name: All checks passed
        run: |
          echo "üéâ All services passed CI checks!"
          echo "‚úÖ auth-service: Build & Lint OK"
          echo "‚úÖ lore-service: Build & Lint OK"
          echo "‚úÖ mythology-service: Build & Lint OK"
